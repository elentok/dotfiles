#!/usr/bin/env bash

set -euo pipefail

source "$(dirname "$0")/../../framework"

ALL_APPS="${HOME}/.apps/all"
LSP_ROOT="${ALL_APPS}/lua-language-server"

function main() {
  apt-fast-install lua5.1 luarocks

  if [ ! -e "$LSP_ROOT/bin/Linux/lua-language-server" ]; then
    install-language-server
  fi

  luarocks install --local formatter
}

function install-language-server() {
  if [ -e "$LSP_ROOT" ]; then
    rm -rf "${LSP_ROOT}.old"
    mv "$LSP_ROOT" "${LSP_ROOT}.old"
  fi

  mkdir -p "$ALL_APPS"
  cd "$ALL_APPS"

  git clone https://github.com/sumneko/lua-language-server
  cd lua-language-server
  git submodule update --init --recursive

  cd 3rd/luamake
  compile/install.sh
  cd ../..
  ./3rd/luamake/luamake rebuild
}

main "$@"
