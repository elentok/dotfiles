#!/usr/bin/env bash
#
# Usage:
#
#   git-wt root
#   git-wt list
#   git-wt dup <name>
#   git-wt pull <worktree-name>

set -euo pipefail

function main() {
  local cmd="${1:-}"
  shift || true

  if type "git-wt-${cmd}" >/dev/null 2>&1; then
    "git-wt-${cmd}" "$@"
  else
    usage "$0"
    exit 1
  fi
}

function git-wt-root() {
  git worktree list | grep '(bare)' | head -1 | awk '{ print $1 }'
}

function git-wt-preview() {
  local worktree="$1"
  cd "$(git-wt-root)/${worktree}"
  git log -1 --color=always --pretty='format:%C(auto)%D%nHash: %h%n%n%s'
}

function git-wt-list() {
  wt_dir="$(git-wt-root)/worktrees"
  if [ -d "$wt_dir" ]; then
    cd "$wt_dir" && command ls -1
  fi
}

function fzf-pick-worktree() {
  fzf --tmux=95%,80% \
    --ansi \
    --prompt='Pick worktree: ' \
    --preview-window=right:70% \
    --preview='git-wt preview {}'
}

function git-wt-dup() {
  local new_name="${1:-}"

  if [ -z "$new_name" ]; then
    echo "Usage: git-wt dup <new-worktree-name>" >&2
    exit 1
  fi

  local current_commit
  current_commit=$(git rev-parse HEAD)

  local worktree_root
  worktree_root="$(git-wt-root)"

  if [ -z "$worktree_root" ]; then
    echo "Error: could not find bare worktree root." >&2
    exit 1
  fi

  local new_path="${worktree_root}/${new_name}"

  if [ -e "$new_path" ]; then
    echo "Error: '${new_path}' already exists." >&2
    exit 1
  fi

  git worktree add -b "$new_name" "$new_path" "$current_commit"
  echo "Created worktree at ${new_path} on branch ${new_name}"
}

function git-wt-pull() {
  local worktree_name="${1:-}"

  if [ -z "$worktree_name" ]; then
    echo "Usage: git-wt pull <worktree-name>" >&2
    exit 1
  fi

  local worktree_root
  worktree_root="$(git-wt-root)"

  local worktree_path="${worktree_root}/${worktree_name}"
  
  if [ ! -d "$worktree_path" ]; then
    echo "Error: worktree '${worktree_name}' not found at ${worktree_path}." >&2
    exit 1
  fi

  cd "$worktree_path"
  echo "Pulling in worktree '${worktree_name}'..."
  git pull
}

function git-wt-pick() {
  worktree="$(git-wt-list | fzf-pick-worktree)"
  if [ -n "$worktree" ]; then
    echo "$(git-wt-root)/${worktree}"
  else
    exit 1
  fi
}

main "$@"
