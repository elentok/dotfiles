#!/bin/bash

source $DOTF/framework

function main() {
  ROOT=$(find-parent-with .git tags Gemfile)

  header "Generating ctags for ${ROOT}"

  build_exclude_args

  bullet 'Generating... '

  ctags $EXCLUDE_ARGS -R --c++-kinds=+p --fields=+ilaS --extra=+q \
    --exclude=@$DOTF/vim/ctagsignore \
    -f $ROOT/tags $ROOT
  if [ $? -eq 0 ]; then
    success "done (generated $(count-ctags) tags)."
  else
    error 'FAILED.'
  fi
}

function build_exclude_args() {
  EXCLUDE_ARGS=""

  if [ -e "$DOTF/vim/ctagsignore" ]; then
    bullet "Loading $DOTF/vim/ctagsignore\n"
    EXCLUDE_ARGS="--exclude=@$DOTF/vim/ctagsignore"
  fi

  if [ -e "$ROOT/.ctagsignore" ]; then
    bullet "Loading $ROOT/.ctagsignore\n"
    EXCLUDE_ARGS="$EXCLUDE_ARGS --exclude=@$ROOT/.ctagsignore"
  fi
}

function count-ctags() {
  grep -v '^!' $ROOT/tags | wc -l | $SED 's/\s*//g'
}

main "$@"
