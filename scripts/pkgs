#!/usr/bin/ruby

require "#{ENV['DOTF']}/framework.rb"
require 'date'

require_relative './packages/reader'
require_relative './packages/tracker'

def main
  if ARGV.length == 0
    usage
  else
    cmd = ARGV.shift
    packages = PackageReader.read('~/.packages')
    if cmd == 'report'
      PackagePrinter.print(packages)
    elsif cmd == 'track'
      PackageTracker.track(packages)
    end
  end
end

def usage
  puts <<-EOF
pkgs - package tracking utility

Usage:

  pkgs report
  pkgs show

  EOF
end

class PackagePrinter
  def initialize(packages)
    @packages = packages.sort_by(&:order)
  end

  def print
    @title_width = @packages.map() { |pkg| pkg.title.length }.max

    @packages.group_by(&:when_to_expect).each do |when_to_expect, pkgs|
      puts green("#{when_to_expect.capitalize}")
      pkgs.sort_by(&:days_ago).reverse.each { |pkg| print_pkg(pkg) }
      puts
    end
  end

  def print_pkg(pkg)
    puts "â˜» #{pkg.pretty_name(@title_width)}"
  end

  def self.print(packages)
    self.new(packages).print
  end
end

main
